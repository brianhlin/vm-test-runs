#!/bin/sh

safe_run()
{
    "$@"
    exit_status=$?
    if [[ $exit_status -ne 0 ]]; then
        echo "==> FAILED with exit status $exit_status"
        exit $exit_status
    fi
}

print_help()
{
    echo "help: $0 [-n] [-p YYYYMMDD-HHMM] <label>"
    echo "Options:"
    echo "    -n"
    echo "       Run as nightly test i.e. immediately submit the DAG after setting up the test run"
    echo "    -p YYYYMMDD-HHMM"
    echo "       Use yaml parameters from a previous run with given timestamp"
    echo '    -h, -help, --help'
    echo "       Print this dialogue"

}

TEST_HOME=/osgtest/runs
NIGHTLY=0
PARAMETERS_BASE=""

set_parameters_base()
{
    case $1 in
        20[0-9][0-9][0-1][0-9][0-3][0-9]-[0-2][0-9][0-5][0-9])
            PARAMETERS_BASE=$TEST_HOME/run-$1/parameters.d
            if ! [ -d "$PARAMETERS_BASE" ]; then
                echo "No such directory: '$PARAMETERS_BASE'"
                print_help
                exit 1
            fi
            ;;
        *)
            echo "Option '-p' takes a YYYYMMDD-HHMM argument."
            print_help
            exit 1
            ;;
    esac
}

# Parse options and required label arg
while getopts :nhp: opt; do
    case $opt in
        n)
            NIGHTLY=1
            ;;
        h)
            print_help
            exit 0
            ;;
        p)
            set_parameters_base "$OPTARG"
            ;;
        \?)
            echo "Invalid option: -$opt"
            print_help
            exit 1
            ;;
    esac
done

shift $(($OPTIND-1)) # Pop options we've already read

if [[ $# -ne 1 ]]; then
    echo "ERROR: Received incorrect number of arguments: $#. Expecting one 'label' argument"
    print_help
    exit 1
fi

LABEL="$1"
if [[ ! -d $TEST_HOME ]]; then
    safe_run mkdir -p $TEST_HOME
fi

RUN_DIR_NAME=`date '+run-%Y%m%d-%H%M'`
RUN_DIRECTORY=$TEST_HOME/$RUN_DIR_NAME
echo "Run directory: $RUN_DIRECTORY"

# Make the new run directory
safe_run mkdir $RUN_DIRECTORY

# Check out files to a temporary directory
TEMP_DIR=`mktemp --directory`
GIT_CHECKOUT_DIR=$TEMP_DIR/git-files
safe_run git clone --quiet --depth 1 https://github.com/opensciencegrid/vm-test-runs $GIT_CHECKOUT_DIR

# Copy needed files to the run directory
cd $GIT_CHECKOUT_DIR
safe_run cp -r \
    master-run.dag \
    generate-dag.sub generate-dag osg-test.conf parameters.d test-exceptions.yaml component-tags.yaml \
    create-io-images.sub create-io-images \
    run-job osg-test.patch test-changes.patch osg-release.patch single-test-run.sub true.sub inner-dag.config \
    process-job-output extract-job-output analyze_job_output.py \
    combine-job-analyses analyze-test-run.sub analyze-test-run email-analysis vmu.py \
    report-job-failures report-job-failures.sub \
    vmu-reporter html-report.sub taglib.py \
    upload-job-output upload-job-output.sub \
    $RUN_DIRECTORY/

if [ -n "$PARAMETERS_BASE" ]; then
    echo "Copying run parameters from $PARAMETERS_BASE"
    rm -f $RUN_DIRECTORY/parameters.d/*.yaml
    safe_run cp "$PARAMETERS_BASE"/*.yaml $RUN_DIRECTORY/parameters.d/
fi

cp /osgtest/rpms/osg-test-*.rpm $RUN_DIRECTORY/ 2> /dev/null
cd $RUN_DIRECTORY
if [ "x$TEMP_DIR" != 'x' ]; then
    rm -fr "$TEMP_DIR"
fi

if [ $NIGHTLY -eq 1 ]; then
    echo "$LABEL" > $RUN_DIRECTORY/run_label
    condor_submit_dag master-run.dag
else
    echo "$LABEL ($USER)" > $RUN_DIRECTORY/run_label
    echo 'Run tests with:'
    echo "    cd $RUN_DIRECTORY"
    echo '    condor_submit_dag master-run.dag'
    exit 0
fi
